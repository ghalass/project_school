name: Deploy to VPS
uses: appleboy/ssh-action@v1.2.0
with:
  host: ${{ secrets.VPS_HOST }}
  username: ${{ secrets.VPS_USER }}
  password: ${{ secrets.VPS_PASSWORD }}
  port: 22
  script: |
    set -e
    mkdir -p /root/my_school
    cd /root/my_school

    echo "=== ðŸ“¦ CrÃ©ation du fichier .env ==="
    echo "DATABASE_URL=mysql://my_school_user:my_school_pass@db_my_school:3306/my_school_db" > .env
    echo "NODE_ENV=production" >> .env
    echo "PORT=5001" >> .env
    echo "URL=http://localhost" >> .env
    echo "TOKEN_EXPIRE_IN=7h" >> .env
    echo "ACCESS_TOKEN_SECRET=${{ secrets.BACKEND_ACCESS_TOKEN_SECRET }}" >> .env

    echo "=== ðŸ”„ Mise Ã  jour des images ==="
    docker-compose down || true
    docker pull ${{ secrets.DOCKERHUB_USERNAME }}/my_school_backend:latest
    docker pull ${{ secrets.DOCKERHUB_USERNAME }}/my_school_frontend:latest

    echo "=== ðŸŒ VÃ©rification du rÃ©seau nginx-proxy ==="
    docker network inspect nginx-proxy >/dev/null 2>&1 || docker network create nginx-proxy

    echo "=== ðŸš€ DÃ©marrage du proxy si nÃ©cessaire ==="
    if [ -z "$(docker ps -q -f name=nginx-proxy)" ]; then
      docker run -d \
        --name nginx-proxy \
        --network nginx-proxy \
        -p 80:80 -p 443:443 \
        -v /var/run/docker.sock:/tmp/docker.sock:ro \
        -v /etc/nginx/certs:/etc/nginx/certs \
        -v /etc/nginx/vhost.d \
        -v /usr/share/nginx/html \
        jwilder/nginx-proxy
    fi

    echo "=== ðŸ” Installation de Certbot si nÃ©cessaire ==="
    if ! command -v certbot >/dev/null 2>&1; then
      apt-get update -y
      apt-get install -y certbot python3-certbot-nginx
    fi

    echo "=== ðŸ“œ VÃ©rification du certificat SSL ==="
    if [ ! -d "/etc/letsencrypt/live/school.ghalass.com" ]; then
      certbot --nginx --non-interactive --agree-tos -m admin@ghalass.com \
        -d school.ghalass.com -d api.school.ghalass.com
    else
      echo "Certificat SSL dÃ©jÃ  prÃ©sent, vÃ©rification du renouvellement..."
      certbot renew --quiet
    fi

    echo "=== ðŸ§© DÃ©marrage du stack my_school ==="
    docker-compose up -d